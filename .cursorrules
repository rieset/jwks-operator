# Правила разработки JWKS Operator

## ⚠️ КРИТИЧЕСКОЕ ТРЕБОВАНИЕ

**НЕ СОЗДАВАТЬ ФАЙЛЫ ДО ЯВНОГО ЗАПРОСА ПОЛЬЗОВАТЕЛЯ**

- ❌ **ЗАПРЕЩЕНО** создавать файлы без явного указания пользователя
- ✅ **РАЗРЕШЕНО** создавать файлы только когда пользователь явно просит это сделать
- ✅ **РАЗРЕШЕНО** редактировать существующие файлы по запросу пользователя
- ✅ **РАЗРЕШЕНО** предлагать создание файлов, но не создавать их без подтверждения

**Это требование имеет наивысший приоритет и должно соблюдаться всегда.**

## Общие принципы

1. **Следовать best practices Go разработки**
2. **Применять правила линтинга из GitHub Actions**
3. **Ограничивать размер файлов до 500 строк**
4. **Делить код на модули при превышении 300 строк**
5. **Не хардкодить значения - использовать config.yaml**

## Структура проекта

```
jwks/
├── cmd/           # Точки входа приложения
├── pkg/           # Основной код оператора
│   ├── controller/ # Контроллеры
│   ├── jwks/      # Генерация JWKS
│   ├── configmap/ # Управление ConfigMap
│   └── reconciler/# Реконсиляция
├── api/           # API определения (CRD)
├── config/        # Конфигурационные файлы
├── docs/          # Документация
└── test/          # Тесты

```

## Правила кодирования

### Именование файлов

- **КРИТИЧЕСКОЕ ТРЕБОВАНИЕ: НЕ использовать капс (заглавные буквы) в именах файлов**
- **Исключения**: стандартные файлы проекта (README.md, Dockerfile, Makefile, Chart.yaml и т.д.)
- **Стиль именования**: 
  - Документация (`docs/`): **ОБЯЗАТЕЛЬНО snake_case** (например, `project_structure.md`, `configuration.md`, `documentation_plan.md`)
  - Go файлы: snake_case для тестов (`*_test.go`), camelCase для остальных
  - Конфигурационные файлы: kebab-case или snake_case
- **При создании новых файлов** - следовать существующему стилю в соответствующей директории
- **ВАЖНО**: Все файлы в `docs/` должны быть в lowercase (snake_case для многословных имен)

### Размер файлов

- **Максимум 500 строк** на файл
- **При превышении 300 строк** - оценить возможность разделения на модули
- **Перед генерацией кода** - оценить количество добавляемых строк

### Модульность

- **Анализировать функции** на возможность выделения в отдельный модуль
- **Один файл = одна ответственность**
- **Избегать циклических зависимостей**

### Конфигурация

- **Не хардкодить значения** - использовать config.yaml
- **Конфигурация интегрируется при билде** через build tags
- **Окружения** определяются через переменные окружения или config.yaml

## Линтинг

### ⚠️ КРИТИЧЕСКОЕ ТРЕБОВАНИЕ

**ВСЕГДА запускать линтинг после создания или изменения файлов!**

### Правила линтинга

Применяются правила из `.github/workflows/lint.yml`:

- `golangci-lint` с конфигурацией `.golangci.yml`
- Проверка форматирования через `gofmt`
- Проверка импортов через `goimports`
- Статический анализ через `staticcheck`

### Процесс (ОБЯЗАТЕЛЬНО после каждого изменения файла)

1. **ОБЯЗАТЕЛЬНО** запустить `gofmt -w <путь_к_файлу>` для форматирования
2. **ОБЯЗАТЕЛЬНО** запустить `goimports -w <путь_к_файлу>` для проверки импортов
3. **ОБЯЗАТЕЛЬНО** запустить `golangci-lint run ./<путь_к_файлу>` или `make lint`
4. **ОБЯЗАТЕЛЬНО** проверить что `gofmt -l .` не показывает измененных файлов
5. **ОБЯЗАТЕЛЬНО** исправить все предупреждения и ошибки перед продолжением
6. **НЕ коммитить код**, который не проходит линтинг

**Последовательность действий:**
```bash
# После изменения файла pkg/nginx/service.go:
gofmt -w pkg/nginx/service.go
goimports -w pkg/nginx/service.go
golangci-lint run ./pkg/nginx/service.go
gofmt -l .  # Должно быть пусто
```

## Best Practices Go

### Именование

- **Пакеты**: короткие, понятные имена в нижнем регистре
- **Экспортируемые функции**: PascalCase
- **Неэкспортируемые функции**: camelCase
- **Константы**: PascalCase или UPPER_SNAKE_CASE

### Обработка ошибок

- **Всегда проверять ошибки**
- **Не игнорировать ошибки** через `_`
- **Использовать `fmt.Errorf` с `%w`** для оборачивания ошибок
- **Добавлять контекст** к ошибкам

### Тестирование

- **Покрытие тестами** минимум 70%
- **Табличные тесты** для множественных сценариев
- **Моки** для внешних зависимостей
- **Интеграционные тесты** для критичных путей

### Документация

- **Документировать все экспортируемые функции**
- **Примеры использования** в godoc
- **Комментарии** для сложной логики

## Работа с Kubernetes API

### Controller-runtime

- Использовать стандартные паттерны controller-runtime
- Правильно обрабатывать RequeueAfter
- Логировать все важные события

### Ресурсы

- Использовать Finalizers для очистки ресурсов
- Правильно обрабатывать удаление ресурсов
- Проверять OwnerReferences

## Конфигурация

### config.yaml

- Все специфичные значения в `config.yaml`
- Окружения определяются через секции в config.yaml
- Конфигурация загружается при старте оператора

### Переменные окружения

- Использовать для чувствительных данных
- Префикс `JWKS_OPERATOR_` для всех переменных
- Значения по умолчанию из config.yaml

## Git Workflow

### Коммиты

- **ОБЯЗАТЕЛЬНО: Все коммиты должны быть на английском языке**
- **Осмысленные сообщения коммитов**
- **Один коммит = одна логическая единица**
- **Не коммитить сломанный код**
- **Формат**: `type: description` (например, `feat: add GitHub Actions workflow`, `fix: correct CRD name`)

### Pull Requests

- **Все тесты должны проходить**
- **Линтинг должен проходить**
- **Покрытие тестами не должно уменьшаться**
- **Документация обновлена**

