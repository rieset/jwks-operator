#!/bin/bash
# Pre-commit hook for JWKS Operator
# Runs linting and formatting checks before commit

set -e

echo "ğŸ” Running pre-commit checks..."

# Check if golangci-lint is available
if ! command -v golangci-lint &> /dev/null; then
    echo "âš ï¸  golangci-lint not found. Installing..."
    make golangci-lint
fi

# Run go fmt to check formatting
echo "ğŸ“ Checking code formatting (go fmt)..."
unformatted=$(gofmt -l .)
if [ -n "$unformatted" ]; then
    echo "âŒ Error: The following files are not formatted:"
    echo "$unformatted"
    echo "ğŸ’¡ Run 'make fmt' to fix"
    exit 1
fi
echo "âœ… Code formatting check passed"

# Run goimports to check imports (if available)
if command -v goimports &> /dev/null; then
    echo "ğŸ“¦ Checking imports (goimports)..."
    unformatted=$(goimports -l .)
    if [ -n "$unformatted" ]; then
        echo "âš ï¸  Warning: The following files have import formatting issues:"
        echo "$unformatted"
        echo "ğŸ’¡ Run 'goimports -w .' to fix"
        # Don't fail, just warn
    else
        echo "âœ… Import formatting check passed"
    fi
else
    echo "âš ï¸  goimports not found, skipping import check"
fi

# Run golangci-lint
echo "ğŸ” Running golangci-lint..."
if ! make lint; then
    echo "âŒ Error: Linting failed. Fix the issues above before committing."
    exit 1
fi
echo "âœ… Linting passed"

echo "ğŸ‰ All pre-commit checks passed!"
exit 0

